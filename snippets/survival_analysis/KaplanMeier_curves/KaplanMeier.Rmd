---
title: "KaplanMeier"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Read in data
```{r}
library(data.table)

surv_dat = fread('/mnt/bbsnippets/survival_example_dat.csv',header = T)
head(surv_dat)

# Column description:
## PID: patient identifier
## grade: tumor pathology grade
## OSmonth: overall suvival from time of diagnosis [months]
## DFSmonth: disease free survival from time of diagnosis [months]
## Patientstatus: life/death status 
### "death by primary disease" = death due to disease
### "death" = disease unrelated death
### "alive" = alive at given survival time
### "alive w metastases" = alive with metasatses at given survival time

```

# Prepare data for Kaplan-Meier survival curves
```{r}
library(survival)

#Censoring for overall survival (1 = event (death due to disease), 0 = censored)
surv_dat$censoringOS = 0
surv_dat$censoringOS[surv_dat$Patientstatus == 'death by primary disease'] = 1

#Censoring for disease free survival (1 = event (recurrence), 0 = censored)
surv_dat$censoringDFS = 0
surv_dat$censoringDFS[surv_dat$Patientstatus == 'alive w metastases'] = 1
surv_dat$censoringDFS[surv_dat$OSmonth > surv_dat$DFSmonth] = 1 


#Survival object for OS and DFS
SurvObj_OS <- Surv(surv_dat$OSmonth, surv_dat$censoringOS)
SurvObj_DFS <- Surv(surv_dat$DFSmonth, surv_dat$censoringDFS)

```

# Compute OS survival curves for the different pathology grades (for DFS just use SurvObj_DFS instead)
```{r}

#Compute survival curve across all patients
KM_all <- survfit(SurvObj_OS ~ 1)

#Compute survival curves for each grade
surv_dat$grade = as.factor(surv_dat$grade)
KM_groups <- survfit(SurvObj_OS ~ surv_dat$grade)

```

# Plot KM survival curves overlaid in one panel
```{r}
library(RColorBrewer)

#Color map
cols = brewer.pal(3,"Dark2")

#All patinets survival curve: black, grade survival curves: color (CIs for strata not plotted)
plot(KM_groups,mark.time = T,col = cols[as.numeric(levels(surv_dat$grade))],conf.int = F)
par(new=TRUE)
plot(KM_all,mark.time = T,col = "black",conf.int = T)
legend(1,1,levels(surv_dat$grade),cols[as.numeric(levels(surv_dat$grade))])

```

# Plot each group KM survival curve in individual panel
```{r}

#Loop through grades to plot each in separate panel (plot CIs)
par(mfrow=c(1,3))
for (i in levels(surv_dat$grade)){
  
  #Data corresponding to current grade
  cur_dat = subset(surv_dat, surv_dat$grade == i)
  SurvObj_cur <- Surv(cur_dat$OSmonth, cur_dat$censoringOS)
  KM_cur <- survfit(SurvObj_cur ~ 1)
  
  #Current grade group in color
  plot(KM_cur,mark.time = T,col = cols[as.numeric(i)],xlim=range(1:250),conf.int = T)
  par(new=TRUE)
  #All patients curve in black
  plot(KM_all,mark.time = T,col = "black",xlim=range(1:250),conf.int = T)
  legend("bottomleft",1,i,cols[as.numeric(i)], cex=3)
}


```

```{r}
sessionInfo()
```
