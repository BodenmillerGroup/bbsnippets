---
title: "Giotto Analysis"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script uses the recently published Giotto package to perform low- and higher-level spatial analyses on IMC data.

## Installation

The technical requirements for this package are: R (>= 3.5.1), Python (>= 3.0) and a Unix/Linux system.
To install the R version of Giotto, execute the following code.

```{r installation-1, eval=FALSE}
library(devtools)
install_github("RubD/Giotto")
```

To fully use the package, the following python packages need to be installed:

```{r installation-2, eval=FALSE}
# pandas:
conda install -c anaconda pandas

# python-igraph:
conda install -c conda-forge python-igraph
conda install -c conda-forge/label/gcc7 python-igraph
conda install -c conda-forge/label/cf201901 python-igraph 

# networkx:
conda install -c anaconda networkx

# louvain:
conda install -c conda-forge python-louvain
conda install -c conda-forge/label/gcc7 python-louvain
conda install -c conda-forge/label/cf201901 python-louvain

# leidenalg:
conda install -c conda-forge leidenalg
```

Finally, in order to use the hidden markov random field approach as explained [here](https://www.nature.com/articles/nbt.4260), the following R package needs to be installed:

```{r installation-3, eval=FALSE}
install_bitbucket("qzhudfci/smfishhmrf-r", ref="default")
```

The package can now be loaded:

```{r load-package}
library(Giotto)
```

## Reading in the data

In the first instance, we want to create the `giotto` R object, which is an S4 class object storing all relevant metadata.
As an example, I will use the cell data from a single image generated for the Damond _et al._ paper available [here](https://www.sciencedirect.com/science/article/pii/S1550413118306910#sec4).

First, we will read in the cell-level ion counts.

```{r read-data}
if(!file.exists("All_Cells.csv")){
  download.file(url = "https://data.mendeley.com/datasets/cydmwsfztj/1/files/bf3c4c19-7105-460d-b348-67bed6a29ed5/Cells.7z?dl=1",
              destfile = "Cells.7z")
  system('7z e Cells.7z')
  file.remove("Cells.7z")
}

# Read in the cell-level counts
library(data.table)
cells <- fread("All_Cells.csv")
```

For convenience, we will only run Giotto on one single image.

```{r select-image}
cells <- cells[cells$ImageNumber == "1",]
```

We will next link all available metadata to the selected image.
The image numbers saved in the All_Cells.csv file correspond to the CellProfiler (CP) output.
To link the CP image numbers to the actual image numbers, a metadata file is available.

```{r metadata}
# Image metadata
if(!file.exists("All_Cells.csv")){
  download.file(url = "https://data.mendeley.com/datasets/cydmwsfztj/1/files/540455ba-3253-4f9b-b49f-c24542563da5/Image.7z?dl=1",
              destfile = "Image.7z")
  system('7z e Image.7z')
  file.remove("Image.7z")
}
image.meta <- read.csv("All_Image.csv")

# Retrieve the actual image number
image.number <- image.meta[image.meta$ImageNumber == unique(cells$ImageNumber),"Metadata_Core"]
image.number
```

In the next step, we need to find the patient that corresponds to the retrieved image.
For this, a metadata file that contains the link between patients and images is available.

```{r}
patient.meta <- read.csv(file = url("https://data.mendeley.com/datasets/cydmwsfztj/1/files/fd3aae49-310e-4f0f-b92d-7ba2fad8aead/Metadata.csv?dl=1"))

# Retrieve patient
patient.number <- patient.meta[patient.meta$image == image.number,"case"]
patient.number
```